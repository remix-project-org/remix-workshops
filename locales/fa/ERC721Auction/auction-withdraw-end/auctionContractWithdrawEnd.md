در این بخش، قرارداد را تمام می‌کنیم، تابعی برای پس گرفتن پیشنهادهای داده شده توسط یک حساب کاربری ایجاد می‌کنیم و تابعی برای پایان دادن به حراج ایجاد می‌کنیم.

### عقب نشینی

ما یک متغیر محلی به نام `bal` (balance) ایجاد می‌کنیم که کل ارزش پیشنهادهایی را که فراخوانی‌کننده تابع (خط ۷۵) از آخرین برداشت خود ارائه داده است، ذخیره می‌کند. ما می‌توانیم با دسترسی به نگاشت bids با استفاده از آدرس فراخوانی‌کننده تابع به عنوان کلید، این مقدار را به `bal` اختصاص دهیم.

در مرحله بعد، مقدار آدرس فراخوانی‌کننده تابع را در نگاشت پیشنهادها روی 0 تنظیم می‌کنیم زیرا آنها کل مقدار پیشنهادها خود را پس می‌گیرند (خط 76).

حالا آن مقدار ETH را از قرارداد به فراخوانی‌کننده تابع منتقل می‌کنیم و رویداد `Withdraw` را منتشر می‌کنیم (خط ۷۹).

### پایان

قبل از اینکه فراخوانی‌کننده‌ی تابع بتواند این تابع را اجرا کند و حراج را پایان دهد، باید بررسی کنیم که آیا شرایط خاصی برقرار است یا خیر. حراج باید شروع شده باشد (خط ۸۳)، تاریخ پایان حراج باید رسیده باشد (خط ۸۴) و حراج نباید قبلاً پایان یافته باشد (خط ۸۵).

پس از پایان حراج، متغیر وضعیت `ended` را روی `true` تنظیم می‌کنیم (خط ۸۷).

ما بررسی می‌کنیم که آیا کسی در حراج شرکت کرده و روی NFT پیشنهاد قیمت داده است یا خیر (خط ۸۸).

اگر پیشنهادی وجود داشته باشد، NFT را از قرارداد به بالاترین پیشنهاد دهنده (خط ۸۹) منتقل می‌کنیم و ETH ارسال شده از بالاترین پیشنهاد دهنده به قرارداد، اکنون به آدرس حراج‌گذار، فروشنده NFT (خط ۹۰) منتقل می‌کنیم.

اگر کسی روی NFT پیشنهادی ارائه ندهد، NFT را به حراج‌گذار (خط ۹۲) برمی‌گردانیم.

در نهایت، رویداد `End` را منتشر می‌کنیم (خط ۹۵).

## ⭐️ تکلیف

1. یک قرارداد NFT راه‌اندازی کنید. شما می‌توانید از قرارداد NFT که ما در دوره آموزشی Solidity NFT در Learneth ایجاد کرده‌ایم، استفاده کنید.

2. برای خودتان یک NFT با شناسه توکن ۰ ایجاد کنید.

3. برای اهداف آزمایشی، مقداری که به متغیر وضعیت `endAt` (خط ۵۴) اختصاص داده شده است را از `۷ روز` به `۵ دقیقه` تغییر دهید.

4. این قرارداد EnglishAuction را مستقر کنید. از آدرس قرارداد NFT به عنوان آرگومان برای پارامتر `_nft`، 0 برای `_nftId` و 1 برای `_startingBid` استفاده کنید.

5. تابع «تأیید» قرارداد NFT خود را با آدرس قرارداد حراج به عنوان آرگومان برای پارامتر «to» و ۰ برای «tokenId» فراخوانی کنید.

6. تابع «شروع» قرارداد حراج خود را فراخوانی کنید.

7. با استفاده از حساب ۱، ۲ اتر و با استفاده از حساب ۲، ۳ اتر پیشنهاد دهید. طبق قرارداد حراج خود عمل کنید. اگر تابع `highestBidder` را فراخوانی کنید، اکنون باید آدرس حساب ۲ را برگرداند.

8. تابع `withdraw` را با حساب ۱ فراخوانی کنید. در موجودی حساب ۱، باید ۲ اتر منهای مقداری از کارمزد تراکنش‌ها را ببینید.

9. پس از گذشت ۵ دقیقه، تابع `end` را فراخوانی کنید. سپس، تابع `ended` را فراخوانی کنید که باید مقدار `true` را برگرداند.

در قرارداد NFT، اگر تابع `ownerOf` را با توکنId 0 فراخوانی کنید، باید آدرس حساب 2 را برگرداند. اگر به موجودی حساب ۱ نگاه کنید، باید ۳ اتر منهای مقداری کارمزد تراکنش افزایش یافته باشد.
